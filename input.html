const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

const images = {
    snake: new Image(),
    egg: new Image(),
    nestEmpty: new Image(),
    nestFull: new Image(),
    predator: new Image(),
    jungle: new Image()
};

images.snake.src = 'snake.png';
images.egg.src = 'egg.png';
images.nestEmpty.src = 'nest.png';
images.nestFull.src = 'nest_full.png';
images.predator.src = 'predator.png';
images.jungle.src = 'jungle.png';

const tileSize = 20;
let snake = [{ x: 100, y: 100 }];
let predator = { x: 400, y: 300, direction: 'UP' };
let snakeDirection = 'RIGHT';
let eggs = [];
let nest = { x: canvas.width / 2 - tileSize, y: canvas.height / 2 - tileSize };
let score = 0;
let gameStarted = false;
let nestFull = false;

// Preload all images before starting
let imagesLoaded = 0;
for (let key in images) {
    images[key].onload = () => {
        imagesLoaded++;
        if (imagesLoaded === Object.keys(images).length) {
            showInstructions();
        }
    };
}

// Controls
document.addEventListener('keydown', (event) => {
    if (!gameStarted) return;
    const key = event.key;
    if (key === 'ArrowUp' && snakeDirection !== 'DOWN') snakeDirection = 'UP';
    if (key === 'ArrowDown' && snakeDirection !== 'UP') snakeDirection = 'DOWN';
    if (key === 'ArrowLeft' && snakeDirection !== 'RIGHT') snakeDirection = 'LEFT';
    if (key === 'ArrowRight' && snakeDirection !== 'LEFT') snakeDirection = 'RIGHT';
});

// Instruction Screen
function showInstructions() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'white';
    ctx.font = '24px Arial';
    ctx.textAlign = 'center';
    ctx.fillText("Oh no! The mother snake's eggs have fallen apart!", canvas.width / 2, canvas.height / 4);
    ctx.fillText("Help her pick them up and glue them together!", canvas.width / 2, canvas.height / 3);
    ctx.fillText("Use the arrow keys to move.", canvas.width / 2, canvas.height / 2);
    ctx.fillText("Avoid the red predator snake!", canvas.width / 2, canvas.height / 1.5);
    ctx.fillText("Press any key to start!", canvas.width / 2, canvas.height / 1.2);

    document.addEventListener('keydown', startGame, { once: true });
}

// Start Game
function startGame() {
    gameStarted = true;
    nestFull = false;
    snake = [{ x: 100, y: 100 }];
    predator = { x: 400, y: 300 };
    score = 0;
    generateEggs();
    gameLoop();
}

// Generate Eggs at Random Locations
function generateEggs() {
    eggs = [];
    while (eggs.length < 4) {
        let newEgg = {
            x: Math.floor(Math.random() * (canvas.width / tileSize)) * tileSize,
            y: Math.floor(Math.random() * (canvas.height / tileSize)) * tileSize
        };
        if (!isColliding(newEgg, nest) && !isColliding(newEgg, predator)) {
            eggs.push(newEgg);
        }
    }
}

// Check Collision Helper
function isColliding(obj1, obj2) {
    return obj1.x === obj2.x && obj1.y === obj2.y;
}

// Draw Elements
function drawSnake() {
    snake.forEach(segment => ctx.drawImage(images.snake, segment.x, segment.y, tileSize, tileSize));
}

function drawEggs() {
    eggs.forEach(egg => ctx.drawImage(images.egg, egg.x, egg.y, tileSize, tileSize));
}

function drawNest() {
    let nestImg = nestFull ? images.nestFull : images.nestEmpty;
    ctx.drawImage(nestImg, nest.x, nest.y, tileSize * 2, tileSize * 2);
}

function drawPredator() {
    ctx.drawImage(images.predator, predator.x, predator.y, tileSize, tileSize);
}

function drawBackground() {
    ctx.drawImage(images.jungle, 0, 0, canvas.width, canvas.height);
}

// Move Snake
function moveSnake() {
    let head = { ...snake[0] };

    if (snakeDirection === 'UP') head.y -= tileSize;
    if (snakeDirection === 'DOWN') head.y += tileSize;
    if (snakeDirection === 'LEFT') head.x -= tileSize;
    if (snakeDirection === 'RIGHT') head.x += tileSize;

    snake.unshift(head);

    // Check if Snake Collects an Egg
    for (let i = 0; i < eggs.length; i++) {
        if (isColliding(head, eggs[i])) {
            score++;
            eggs.splice(i, 1);
            break;
        }
    }

    // If All Eggs Collected, Transform Nest
    if (eggs.length === 0 && !nestFull) {
        setTimeout(() => {
            nestFull = true;
            showWinMessage();
        }, 500);
    } else {
        snake.pop();
    }

    // Check Collision with Predator
    if (isColliding(head, predator)) {
        alert('Game Over! The predator caught you!');
        resetGame();
    }
}

// Move Predator Towards Nearest Egg
function movePredator() {
    if (eggs.length === 0) return;

    let nearestEgg = eggs.reduce((closest, egg) => {
        let dist = Math.abs(predator.x - egg.x) + Math.abs(predator.y - egg.y);
        let closestDist = Math.abs(predator.x - closest.x) + Math.abs(predator.y - closest.y);
        return dist < closestDist ? egg : closest;
    });

    if (predator.x < nearestEgg.x) predator.x += tileSize;
    if (predator.x > nearestEgg.x) predator.x -= tileSize;
    if (predator.y < nearestEgg.y) predator.y += tileSize;
    if (predator.y > nearestEgg.y) predator.y -= tileSize;

    for (let i = 0; i < eggs.length; i++) {
        if (isColliding(predator, eggs[i])) {
            eggs.splice(i, 1);
            break;
        }
    }
}

// Win Message
function showWinMessage() {
    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'white';
    ctx.font = '30px Arial';
    ctx.textAlign = 'center';
    ctx.fillText("You saved all the eggs!", canvas.width / 2, canvas.height / 2);
    ctx.fillText("The mother snake is happy!", canvas.width / 2, canvas.height / 1.8);
    ctx.fillText("Press any key to restart.", canvas.width / 2, canvas.height / 1.5);

    document.addEventListener('keydown', resetGame, { once: true });
}

// Reset Game
function resetGame() {
    gameStarted = false;
    nestFull = false;
    showInstructions();
}

// Game Loop
function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawBackground();
    drawSnake();
    drawEggs();
    drawNest();
    drawPredator();
    moveSnake();
    movePredator();

    if (!nestFull) {
        requestAnimationFrame(gameLoop);
    }
}
